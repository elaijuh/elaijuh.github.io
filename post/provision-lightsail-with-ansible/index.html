
<!DOCTYPE html>
<html lang="en-us">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="" name="keywords">
<meta content="Provision AWS Lightsail with Ansible - moo..." property="og:title">
<title>Provision AWS Lightsail with Ansible | moo...</title>
<link rel="stylesheet" href="http://blog.hujiale.me//css/style.css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://blog.hujiale.me/"><h1 class="title is-4">moo...</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/elaijuh">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/hjiale">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://www.linkedin.com/in/jiale-hu-22106632/">
            <span class="icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="subtitle is-6">December 21, 2016</h2>
    <h1 class="title">Provision AWS Lightsail with Ansible</h1>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/aws">aws</a>
    
        <a class="button is-link" href="/tags/ansible">ansible</a>
    
</div>

    
    <div class="content">
      

<p>Amazon has announced a new cloud service <strong>Lightsail</strong> recently aiming at DigitalOcean, with exact same price and same spec of node.  As a heavy DigitalOcean user, I am more than happy to try the alternative provided by AWS. Creating the first instance is not smooth, I got successfully created the first instance by AWS SDK after 3 weeks in and out mails with the support team.</p>

<p>TL;DR</p>

<p>This post is a quick guide on provisioning the instance by Ansible.  Before that ,  some outlines:</p>

<ul>
<li>The default login account for Lightsail is pretty much depended on the image, while in DigitalOcean it is <strong>root</strong>.</li>
<li>Lightsail is using key pair (.pem) for ssh login, you can either use default key pair or create a new pair. After successfully log into the instance, I added a pub ssh id by my preference.</li>
<li>Everything in docker, as well as ansible</li>
</ul>

<h2 id="ansible-playbook">Ansible playbook</h2>

<p>provision.yml</p>

<pre><code class="language-yml">---
- hosts: cloud 
  gather_facts: False
  tasks:
    - name: Update local known_hosts
      local_action: shell ssh-keyscan -H {{ hostvars[item].ansible_host }} &gt;&gt; ~/.ssh/known_hosts
      with_items: &quot;{{ groups.cloud }}&quot;

    - name: Install aptitude
      raw: test ! -e /usr/bin/aptitude &amp;&amp; sudo apt-get install -qq aptitude || true

    - name: Install python 2.7
      raw: test ! -e /usr/bin/python &amp;&amp; (sudo apt-get update -qq &amp;&amp; sudo apt-get install -qq python2.7) || true

    - name: Install letsencrypt 
      raw: test ! -e /usr/bin/letsencrypt &amp;&amp; (sudo apt-get update -qq &amp;&amp; sudo apt-get install -qq letsencrypt) || true

- hosts: cloud 
  roles:
    - update-apt
    - user
    - swap

- hosts: cloud 
  roles:
    # https://github.com/angstwad/docker.ubuntu
    - role: angstwad.docker_ubuntu
      become: yes
      kernel_pkg_state: present
</code></pre>

<p>provision.ini</p>

<pre><code class="language-ini">[hosts]
[YOUR_LIGHTSAIL_INSTANCE_NAME] ansible_host=[YOUR_IP] private_ip=[YOUR_PRIVATE_IP]

[cloud:children]
hosts

[cloud:vars]
ansible_connection=ssh
ansible_user=ubuntu
ansible_ssh_private_key_file=~/.ssh/id_rsa
ansible_python_interpreter=/usr/bin/python2.7
</code></pre>

<p>Looking at <code>provision.yml</code> , the first 3 common tasks are pretty straight forward:</p>

<ul>
<li>Adding remote instance IP to your local known_hosts</li>
<li>Install Python</li>
<li>Install letsencrypt for HTTPS</li>
</ul>

<p>Followed by 3 common roles:</p>

<ul>
<li>Update and upgrade apt</li>
<li>Create application user in sudo group</li>
<li>Specify swap file (optional)</li>
</ul>

<p>I would like to pick user role as example</p>

<p>ansible/roles/user/tasks/main.yml</p>

<pre><code class="language-yml">---
- name: Ensure user exists
  become: yes
  user:
    name: appuser
    state: present
    shell: /bin/bash
    append: yes 
    groups: sudo

- name: Ensure authorized key exists
  become: yes
  authorized_key: user=appuser key=&quot;{{ lookup('file', '~/.ssh/id_rsa.pub') }}&quot;

- name: Copy sudoers
  become: yes
  copy: src=./sudoers dest=/etc/sudoers
</code></pre>

<p>This role will create a user <code>appuser</code> in sudo group for application deploy.  So that we don’t need to use the default user <code>ubuntu</code> every time. Make sure you have added the id pub key into the instance’s <code>authorized_key</code> file</p>

<p>The last role is installing docker into the instance, after that you can use any docker command like <code>sudo docker</code> or <code>sudo docker-compose</code> in the instance and it’s armed with docker engine now.</p>

<p>OK now we have a provisioned instance and keep lego it with any application you write. I will suggest to use Ansible docker service as well to depoly your application based on docker image.</p>

    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'hujiale';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/typescript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/yaml.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-57201547-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



